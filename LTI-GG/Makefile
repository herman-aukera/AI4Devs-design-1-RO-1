# LTI ATS MVP - Makefile
# Modern functional programming ATS with Elm + Elixir
.PHONY: setup run test clean format help

# Default target
.DEFAULT_GOAL := help

help: ## Show this help message
	@echo "LTI ATS MVP - Development Commands"
	@echo "=================================="
	@egrep '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-12s\033[0m %s\n", $$1, $$2}'

setup: ## Install all dependencies (backend + frontend)
	@echo "ðŸ”§ Setting up LTI ATS MVP..."
	@echo "ðŸ“¦ Installing backend dependencies..."
	cd backend && mix deps.get
	@echo "ðŸ“¦ Installing frontend dependencies..."
	cd frontend && elm make src/Main.elm --optimize --output=/tmp/elm-test.js > /dev/null 2>&1 || true
	@echo "âœ… Setup complete!"

run: ## Start both frontend and backend servers
	@echo "ðŸš€ Starting LTI ATS MVP..."
	@echo "ðŸ“± Backend: http://localhost:4000"
	@echo "ðŸŒ Frontend: http://localhost:8000"
	@echo "ðŸ” Login: admin / admin123"
	@echo ""
	@echo "Starting servers in parallel..."
	@(cd backend && mix phx.server) & \
	(cd frontend && elm reactor) & \
	wait

test: ## Run all tests (backend + frontend + integration)
	@echo "ðŸ§ª Running comprehensive test suite..."
	@echo "âš¡ Backend unit tests..."
	cd backend && mix test
	@echo "âš¡ Frontend unit tests..."
	cd frontend && elm-test
	@echo "âš¡ Integration tests..."
	./integration-test.sh
	@echo "âœ… All tests completed!"

test-backend: ## Run only backend tests
	@echo "ðŸ§ª Running backend tests..."
	cd backend && mix test

test-frontend: ## Run only frontend tests  
	@echo "ðŸ§ª Running frontend tests..."
	cd frontend && elm-test

test-integration: ## Run integration tests
	@echo "ðŸ§ª Running integration tests..."
	./integration-test.sh

test-e2e: ## Run end-to-end tests
	@echo "ðŸ§ª Running E2E tests..."
	./e2e-test.sh

format: ## Format all code (Elixir + Elm)
	@echo "ðŸŽ¨ Formatting code..."
	cd backend && mix format
	cd frontend && elm-format src/ --yes
	cd frontend && elm-format tests/ --yes
	@echo "âœ… Code formatted!"

clean: ## Clean build artifacts
	@echo "ðŸ§¹ Cleaning build artifacts..."
	cd backend && mix clean
	cd frontend && rm -rf elm-stuff/build-artifacts
	@echo "âœ… Clean complete!"

reset-db: ## Reset in-memory data store
	@echo "ðŸ”„ Resetting in-memory database..."
	@echo "In-memory store will reset automatically on server restart"
	@echo "To reset: stop servers (Ctrl+C) and run 'make run' again"

dev: ## Start development servers with file watching
	@echo "ðŸ”„ Starting development mode with file watching..."
	@(cd backend && mix phx.server) & \
	(cd frontend && elm reactor) & \
	wait

check: ## Run all quality checks
	@echo "ðŸ” Running quality checks..."
	@echo "ðŸ§ª Tests..."
	$(MAKE) test
	@echo "ðŸŽ¨ Format check..."
	$(MAKE) format
	@echo "âœ… Quality checks complete!"

quick-test: ## Quick functionality test
	@echo "âš¡ Quick system test..."
	@echo "1. Ensure servers are running (make run)"
	@echo "2. Open http://localhost:8000/src/Main.elm"
	@echo "3. Login with admin/admin123"
	@echo "4. Create a job and application"
	@echo "5. Verify CRUD operations work"

test-use-cases: ## Test the three main use cases end-to-end
	@echo "ðŸŽ¯ Testing main use cases..."
	@./test-use-cases.sh

status: ## Show system status
	@echo "ðŸ“Š LTI ATS MVP System Status"
	@echo "============================="
	@echo "Backend server: curl -s http://localhost:4000/api/jobs > /dev/null && echo 'âœ… Running' || echo 'âŒ Not running'"
	@echo "Frontend server: curl -s http://localhost:8000 > /dev/null && echo 'âœ… Running' || echo 'âŒ Not running'"
	@echo ""
	@echo "To start: make run"

# Advanced targets for CI/CD
ci-test: ## Run tests suitable for CI environment
	cd backend && mix test --cover
	cd frontend && elm-test
	./integration-test.sh

# Development helpers
deps-backend: ## Install only backend dependencies
	cd backend && mix deps.get

deps-frontend: ## Install only frontend dependencies  
	cd frontend && elm make src/Main.elm --optimize --output=/tmp/elm-test.js > /dev/null 2>&1 || true

# System information
info: ## Show system and dependency information
	@echo "ðŸ” LTI ATS MVP System Information"
	@echo "================================"
	@echo "Elixir version: $(shell elixir --version | head -1)"
	@echo "Elm version: $(shell elm --version 2>/dev/null || echo 'Not installed')"
	@echo "Mix version: $(shell mix --version)"
	@echo "Phoenix version: $(shell cd backend && mix phx.new --version 2>/dev/null || echo 'Check backend/mix.exs')"
	@echo ""
	@echo "Project structure:"
	@echo "â”œâ”€â”€ backend/     # Elixir/Phoenix API"  
	@echo "â”œâ”€â”€ frontend/    # Elm SPA"
	@echo "â”œâ”€â”€ *.sh         # Test scripts"
	@echo "â””â”€â”€ *.md         # Documentation"
